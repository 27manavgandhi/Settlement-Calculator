<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Settlement Calculator</title>
<style>
  :root{
    --fg:#0f172a;--muted:#64748b;--bg:#f8fafc;--card:#fff;--accent:#2563eb;--ok:#16a34a;
    --settle-font: 1.15rem;
    --genie-size:  64px;
    --value-gap:   10px;
    --bronze: #cd7f32;
    --silver: #c0c0c0;
    --gold: #ffd700;
    --diamond: #b9f2ff;
  }

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:10px}
  .card{max-width:720px;width:100%;background:var(--card);border-radius:16px;padding:14px;box-shadow:0 8px 28px rgba(15,23,42,.08)}

  .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .head img.logo{width:220px;height:auto}
  .hi{font-weight:800;color:#be185d;display:flex;align-items:center;gap:6px}
  .hi img{height:26px}

  .mode{
    display:flex; gap:14px; align-items:center; margin:6px 0 4px; color:var(--muted);
    font-size:.92rem; flex-wrap:wrap;
  }
  .mode label{display:inline-flex; align-items:center; gap:6px; cursor:pointer}
  .mode input[type="radio"]{accent-color:var(--accent)}
  .mode input[type="checkbox"]{accent-color:var(--accent)}

  /* Tier buttons */
  .tier-row{
    display:flex; align-items:center; gap:10px; margin:10px 0 6px; flex-wrap:wrap;
  }
  .tier-row strong{color:#0f172a; white-space:nowrap;}
  .tier-buttons{
    display:flex; gap:6px; flex-wrap:wrap;
  }
  .tier-btn{
    padding:6px 12px; border-radius:8px; border:2px solid #e2e8f0;
    background:#f8fafc; cursor:pointer; font-weight:600; font-size:.85rem;
    transition:all 0.2s; white-space:nowrap;
  }
  .tier-btn:hover{ transform:translateY(-1px); }
  .tier-btn.active{ border-width:2px; font-weight:700; }
  .tier-btn.bronze.active{ border-color:var(--bronze); background:rgba(205,127,50,0.1); }
  .tier-btn.silver.active{ border-color:var(--silver); background:rgba(192,192,192,0.1); }
  .tier-btn.gold.active{ border-color:var(--gold); background:rgba(255,215,0,0.1); }
  .tier-btn.diamond.active{ border-color:var(--diamond); background:rgba(185,242,255,0.1); }

  /* Date picker */
  .date-row{
    display:flex; align-items:center; gap:10px; margin:10px 0 6px; flex-wrap:wrap;
  }
  .date-row strong{color:#0f172a; white-space:nowrap;}
  #dateInput{
    padding:8px 12px; border:1px solid #e2e8f0; border-radius:8px;
    font-size:.9rem; background:#fff; width:150px;
  }

  

  .between{display:flex;justify-content:flex-start;margin:0 0 6px}
  #aladdinGif{height:120px;width:auto;image-rendering:pixelated}
  @media(max-width:560px){ #aladdinGif{height:90px} }

  .row{display:grid;grid-template-columns:1fr auto;gap:10px}
  @media(max-width:560px){.row{grid-template-columns:1fr}}
  label[for="priceInput"]{font-size:.9rem;color:var(--muted)}
  input{width:100%;border:1px solid #e2e8f0;border-radius:12px;padding:12px;font-size:1rem}
  select{border:1px solid #e2e8f0;border-radius:12px;padding:8px 10px;font-size:.9rem;min-width:180px}
  .btns{display:flex;gap:8px;align-items:center}
  button{padding:12px 14px;border-radius:12px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
  button.ghost{background:#e2e8f0;color:#0f172a}

  /* Searchable dropdown styles */
  .searchable-dropdown { position: relative; width: 100%; }
  .search-input {
    width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 12px;
    font-size: 1rem; background: #fff;
  }
  .dropdown-options {
    position: absolute; top: 100%; left: 0; right: 0; background: #fff;
    border: 1px solid #e2e8f0; border-radius: 8px; max-height: 200px;
    overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .dropdown-options.active { display: block; }
  .dropdown-option {
    padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9;
  }
  .dropdown-option:hover { background: #f8fafc; }
  .dropdown-option:last-child { border-bottom: none; }

  .result{
    margin-top:10px;background:#f1f5f9;padding:12px;border-radius:12px;
    position:relative;overflow:hidden;
  }
  .line{display:flex;justify-content:space-between;margin:6px 0;align-items:center}
  .note{margin-top:6px;font-size:.82rem;color:var(--muted)}
  .warn{color:#dc2626;font-size:.85rem;display:none}

  #paneGif{
    position:absolute; inset:0; width:100%; height:100%;
    object-fit:cover; border-radius:inherit;
    display:none; z-index:0; pointer-events:none; opacity:1;
  }
  .pane-playing > *:not(#paneGif){ visibility:hidden }
  .result > *{ position:relative; z-index:1 }

  .line.total{
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    align-items:center;
  }
  .settle-center{
    display:flex;
    align-items:center;
    gap: var(--value-gap);
    justify-content:center;
  }
  #outSettlement{
    font-weight:900; color:var(--ok);
    font-size: var(--settle-font);
    text-align:center;
  }
  #genieImg{
    height: var(--genie-size);
    width:auto;
    display:none;
    pointer-events:none;
    filter: drop-shadow(0 8px 18px rgba(0,0,0,.12));
    animation:bounce .6s ease-in-out 3, blink 1s linear 2;
  }
  #genieImg.show{ display:inline-block; }
  @keyframes bounce{0%,100%{transform:translateY(2px)}50%{transform:translateY(-4px)}}
  @keyframes blink{0%,100%{filter:brightness(1)}50%{filter:brightness(1.2)}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="head">
      <img class="logo" src="logo.png" alt="Click Crazy Logo">
      <div class="hi">Hi Wifey <img id="heartGif" src="222.gif" alt="üíã"></div>
    </div>

    <div class="mode" id="modeBox">
      <strong style="color:#0f172a">I will enter:</strong>
      <label><input type="radio" name="mode" id="modeLP" value="LP" checked> Listing Price</label>
      <label><input type="radio" name="mode" id="modeSP" value="SP"> Selling Price</label>
    </div>

    <!-- Tier = fixed fee slab only -->
    <div class="tier-row">
      <strong>Tier (Fixed Fee):</strong>
      <div class="tier-buttons">
        <div class="tier-btn bronze" data-tier="bronze">Bronze</div>
        <div class="tier-btn silver" data-tier="silver">Silver</div>
        <div class="tier-btn gold active" data-tier="gold">Gold</div>
        <div class="tier-btn diamond" data-tier="diamond">Diamond</div>
      </div>
    </div>

    <!-- Date picker -->
    <!-- Date picker with F-Assured -->
    <div class="date-row">
      <strong>Date:</strong>
      <input type="date" id="dateInput">
      <label style="display:inline-flex;align-items:center;gap:6px;white-space:nowrap;">
        <input type="checkbox" id="fAssured">
        <span>F-Assured</span>
      </label>
    </div>
    <!-- Model slicer + CSV loader -->
    <div class="mode" id="modelRow" style="margin-top:-4px;">
      <strong style="color:#0f172a">Model / Seller SKU:</strong>
      <div class="searchable-dropdown" style="flex:1;">
        <input type="text" id="modelSearch" class="search-input" placeholder="Type to search SKU..." autocomplete="off">
        <div id="modelOptions" class="dropdown-options"></div>
      </div>
      <small id="csvStatus" style="font-size:.78rem;display:block;margin-top:4px;color:#16a34a;">
        <b>üìä Live Data:</b> Synced with Google Sheets
      </small>
    </div>

    <div class="between">
      <img id="aladdinGif" src="aladdin-genie.gif" alt="Genie">
    </div>

    <div class="row">
      <div>
        <label id="priceLabel" for="priceInput">Listing Price (‚Çπ)</label>
        <input id="priceInput" type="number" value="0" placeholder="Enter amount">
      </div>
      <div class="btns" style="align-self:end">
        <button id="calcBtn" type="button">Calculate</button>
        <button id="resetBtn" type="button" class="ghost">Reset</button>
      </div>
    </div>

    <div class="result" id="pane">
      <img id="paneGif" src="genie-aladdin.gif" alt="Pane Genie">

      <div class="line"><span>Listing Price</span><span id="outLP">‚Çπ0.00</span></div>
      <div class="line"><span><b>Selling Price (Derived)</b></span><span id="outSP">‚Çπ0.00</span></div>
      <hr style="border:none;border-top:1px dashed #cbd5e1;">
      <div class="line"><span>Fixed Fee (Tier)</span><span id="outFixed">‚Çπ5.00</span></div>
      <div class="line"><span id="commLabel">Commission (5% of SP)</span><span id="outCommission">‚Çπ0.00</span></div>
      <div class="line"><span>GST on Charges @18%</span><span id="outGst">‚Çπ0.00</span></div>
      <div class="line"><span>TCS (SP/1.18 √ó 0.50%)</span><span id="outTcs">‚Çπ0.00</span></div>
      <div class="line"><span>TDS (SP/1.18 √ó 0.10%)</span><span id="outTds">‚Çπ0.00</span></div>

      <div class="line total">
        <span>Estimated Bank Settlement</span>
        <div class="settle-center">
          <span id="outSettlement">‚Çπ0.00</span>
          <img id="genieImg" src="genie.gif" alt="Genie">
        </div>
        <span></span>
      </div>
      <span id="imgErr" class="warn">(One or more images failed to load)</span>
    </div>

    <div class="note">
      <b>Usage:</b> Data automatically syncs from <b>Google Sheets</b>.<br>
      ‚Ä¢ Click <b>Calculate</b> to fetch latest rates and compute settlement.<br>
      ‚Ä¢ Columns required:<br>
      &nbsp;&nbsp;<code>SELLER SKU</code>, <code>Rate Date</code>,<br>
      &nbsp;&nbsp;<code>NFBF_Comm</code>, <code>NFBF_Bronze</code>, <code>NFBF_Silver</code>, <code>NFBF_Gold</code>, <code>NFBF_Dimond</code>,<br>
      &nbsp;&nbsp;<code>FBF_Comm</code>, <code>FBF_Bronze</code>, <code>FBF_Silver</code>, <code>FBF_Gold</code>, <code>FBF_Dimond</code>.<br>
      ‚Ä¢ <b>Comm columns are %</b> (e.g. 15%), <b>tier columns are Fixed Fee ‚Çπ</b>.<br>
      ‚Ä¢ Customer logistics slabs baked into Listing ‚Üí SP:<br>
      &nbsp;&nbsp;‚Äì Listing ‚â§ 1500 ‚Üí SP = Listing ‚àí 118<br>
      &nbsp;&nbsp;‚Äì 1501 ‚â§ Listing ‚â§ 2500 ‚Üí SP = Listing ‚àí 210<br>
      &nbsp;&nbsp;‚Äì Listing ‚â• 2501 ‚Üí SP = Listing ‚àí 575<br>
      ‚Ä¢ F-Assured: uses <code>FBF_Comm</code> + Fixed Fee from <code>FBF_[Tier]</code> and adds Pick &amp; Pack ‚Çπ14 (shown inside Commission line).<br>
      ‚Ä¢ Non F-Assured: uses <code>NFBF_Comm</code> + Fixed Fee from <code>NFBF_[Tier]</code>.<br>
    </div>
  </div>
</div>

<script>

  

  // üîó PASTE YOUR GOOGLE SHEETS WEB APP URL HERE:
  const SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycbw-sXcTJLr4BLr4sUDSB_IxEjmy3iDnPxuCNLLFGD0xNRfj5eL9WDjLurv-t1csRXbYEg/exec';
  
  let commissionData = {};
  let allSKUs = [];
  let allDates = [];
  let currentTier = 'gold';
  let latestSheetDate = '';
  
  const today = new Date();
  const currentDate = today.toISOString().split('T')[0];
  let selectedModel = '';

  const fmt = n => (isNaN(n)||!isFinite(n)) ? "‚Çπ0.00" :
    new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR',maximumFractionDigits:2}).format(n);
  const el = id => document.getElementById(id);

  function convertToStandardDate(dateStr) {
    if (!dateStr) return '';
    const parts = dateStr.split('-');
    if (parts.length === 3) {
      if (parts[0].length === 2 && parts[2].length === 4) {
        const day = parts[0].padStart(2, '0');
        const month = parts[1].padStart(2, '0');
        const year = parts[2];
        return `${year}-${month}-${day}`;
      } else if (parts[0].length === 4 && parts[2].length === 2) {
        return dateStr;
      }
    }
    return dateStr;
  }

  function formatDateForDisplay(dateStr) {
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return dateStr;
    return date.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
  }

  function setTier(tier){
    currentTier = tier;
    document.querySelectorAll('.tier-btn').forEach(btn => {
      btn.classList.remove('active');
      if(btn.dataset.tier === tier){ btn.classList.add('active'); }
    });
    sessionStorage.setItem('selectedTier', tier);
    compute();
  }

  function setDate(date){
    sessionStorage.setItem('selectedDate', date);
    compute();
  }

  /* searchable dropdown */
  function updateDropdownOptions(searchTerm = '') {
    const optionsContainer = el('modelOptions');
    optionsContainer.innerHTML = '';
    
    if (allSKUs.length === 0) {
      optionsContainer.classList.remove('active');
      return;
    }
    const searchLower = searchTerm.toLowerCase();
    const filtered = allSKUs.filter(sku => 
      sku.toLowerCase().includes(searchLower)
    ).slice(0, 20);
    if (filtered.length === 0) {
      const noResult = document.createElement('div');
      noResult.className = 'dropdown-option';
      noResult.textContent = 'No matching SKUs found';
      optionsContainer.appendChild(noResult);
    } else {
      filtered.forEach(sku => {
        const option = document.createElement('div');
        option.className = 'dropdown-option';
        option.textContent = sku;
        option.dataset.value = sku;
        const index = sku.toLowerCase().indexOf(searchLower);
        if (index !== -1) {
          const before = sku.substring(0, index);
          const match = sku.substring(index, index + searchTerm.length);
          const after = sku.substring(index + searchTerm.length);
          option.innerHTML = `${before}<span style="background:#eff6ff;font-weight:600">${match}</span>${after}`;
        }
        option.addEventListener('click', () => {
          el('modelSearch').value = sku;
          selectedModel = sku;
          optionsContainer.classList.remove('active');
          compute();
        });
        optionsContainer.appendChild(option);
      });
    }
    optionsContainer.classList.add('active');
  }

  function initSearchableDropdown() {
    const searchInput = el('modelSearch');
    const optionsContainer = el('modelOptions');
    
    searchInput.addEventListener('input', (e) => {
      selectedModel = e.target.value;
      updateDropdownOptions(e.target.value);
    });
    
    searchInput.addEventListener('focus', () => {
      updateDropdownOptions(searchInput.value);
    });
    
    searchInput.addEventListener('blur', () => {
      setTimeout(() => { optionsContainer.classList.remove('active'); }, 200);
    });
    
    document.addEventListener('click', (e) => {
      if (!searchInput.contains(e.target) && !optionsContainer.contains(e.target)) {
        optionsContainer.classList.remove('active');
      }
    });
  }

  function sellingFromListing(lp){
    if (lp > 2500)      return lp - 575;
    else if (lp > 1500) return lp - 210;
    else                return lp - 118;
  }

  function listingFromSelling(sp){
    const lp1 = sp + 118;
    if (lp1 <= 1500) return lp1;
    const lp2 = sp + 210;
    if (lp2 <= 2500) return lp2;
    return sp + 575;
  }

  let paneTimer = null;
  function playPaneGif(ms){
    const pane = el('pane');
    pane.classList.add('pane-playing');
    if (paneTimer) clearTimeout(paneTimer);
    paneTimer = setTimeout(() => { pane.classList.remove('pane-playing'); }, ms);
  }

  function updateModeUI(){
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const label = el('priceLabel');
    label.textContent = (mode === 'LP') ? 'Listing Price (‚Çπ)' : 'Selling Price (‚Çπ)';
    el('priceInput').placeholder = (mode === 'LP')
      ? 'Enter listing price'
      : 'Enter selling price';
  }

  /* get rates from commissionData */
  function getRateBlock(sku, date, isFAssured){
    if (!sku || !commissionData[sku]) return null;
    const typeKey = isFAssured ? 'fbf' : 'nfbf';
    const skuData = commissionData[sku];

    if (skuData[date] && skuData[date][typeKey]) {
      return skuData[date][typeKey];
    }

    const dates = Object.keys(skuData).sort();
    let closest = null;
    for (const d of dates){
      if (d <= date) closest = d;
    }
    if (closest && skuData[closest][typeKey]) return skuData[closest][typeKey];

    const lastDate = dates[dates.length-1];
    return skuData[lastDate][typeKey] || null;
  }

  async function compute(){
    // Auto-fetch if no data loaded
    if (Object.keys(commissionData).length === 0) {
      const success = await fetchFromGoogleSheets();
      if (!success) return;
    }
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const val = parseFloat(el('priceInput').value || '0');
    const isFAssured = el('fAssured').checked;
    const tier = currentTier;
    const date = el('dateInput').value || currentDate;

    let lp, sp;
    if (mode === 'LP') {
      lp = val;
      sp = sellingFromListing(lp);
    } else {
      sp = val;
      lp = listingFromSelling(sp);
    }

    // defaults
    let commissionPct = lp > 1500 ? 0.05 : 0.025;
    let fixedFee = 5;
    let dateInfo = '';

    const rateBlock = getRateBlock(selectedModel, date, isFAssured);
    if (rateBlock){
      if (typeof rateBlock.commission === 'number' && !isNaN(rateBlock.commission)){
        commissionPct = rateBlock.commission; // decimal
      }
      if (rateBlock.fixed && rateBlock.fixed[tier] != null &&
          !isNaN(rateBlock.fixed[tier])) {
        // even if 0, override default 5
        fixedFee = rateBlock.fixed[tier];
      }
      const skuData = commissionData[selectedModel];
      if (skuData){
        const dates = Object.keys(skuData).sort();
        let used = null;
        if (skuData[date]) used = date;
        else {
          for (const d of dates){ if (d <= date) used = d; }
          if (!used) used = dates[dates.length-1];
        }
        //if (used) dateInfo = ` (Rate as of ${formatDateForDisplay(used)})`;
      }
    }

    const commissionAmt = sp * commissionPct;
    const pickPack = isFAssured ? 14 : 0;
    const commissionDisplay = commissionAmt + pickPack;

    const gstBase = fixedFee + commissionAmt + pickPack;
    const gst = gstBase * 0.18;
    const tcs = (sp / 1.18) * 0.005;
    const tds = (sp / 1.18) * 0.001;
    const settlement = sp - fixedFee - commissionAmt - pickPack - gst - tcs - tds;

    if (isFAssured){
      el('commLabel').textContent =
        `F-Assured Commission (${(commissionPct*100).toFixed(2)}% of SP) + Pick & Pack ‚Çπ14${dateInfo}`;
    } else {
      el('commLabel').textContent =
        `Commission (${(commissionPct*100).toFixed(2)}% of SP)${dateInfo}`;
    }

    el('outLP').textContent   = fmt(lp);
    el('outSP').textContent   = fmt(sp);
    el('outFixed').textContent= fmt(fixedFee);          // ONLY fixed fee, no P&P
    el('outCommission').textContent = fmt(commissionDisplay); // Commission + P&P for FA
    el('outGst').textContent  = fmt(gst);
    el('outTcs').textContent  = fmt(tcs);
    el('outTds').textContent  = fmt(tds);
    el('outSettlement').textContent = fmt(settlement);

    if (Math.abs(settlement) > 0.005){
      playPaneGif(3000);
      el('genieImg').classList.add('show');
    } else {
      el('genieImg').classList.remove('show');
    }
  }

  function clearOutputs(){
    ['outLP','outSP','outFixed','outCommission','outGst','outTcs','outTds','outSettlement']
      .forEach(id => el(id).textContent = fmt(0));
  }

  function resetUI(){
    el('priceInput').value = 0;
    el('fAssured').checked = false;
    el('modelSearch').value = '';
    selectedModel = '';
    el('modelOptions').classList.remove('active');
    clearOutputs();
    el('genieImg').classList.remove('show');
    const pane = el('pane');
    if (pane) pane.classList.remove('pane-playing');
    el('commLabel').textContent = 'Commission (5% of SP)';
  }

  function populateSKUs() {
    allSKUs = Object.keys(commissionData);
  }

  function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      const nextChar = line[i + 1];
      if (char === '"' && inQuotes && nextChar === '"') {
        current += '"';
        i++;
      } else if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) {
        result.push(current);
        current = '';
      } else {
        current += char;
      }
    }
    result.push(current);
    return result;
  }

 /* function handleCsvFile(file){
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e){
      const text = e.target.result;
      if (!text || text.trim().length === 0) {
        el('csvStatus').textContent = 'CSV file is empty';
        el('csvStatus').style.color = '#dc2626';
        return;
      }
      
      let lines = text.split(/\r\n|\n|\r/);
      lines = lines.map(l => l.trim()).filter(l => l.length > 0);
      if (lines.length < 2) {
        el('csvStatus').textContent = 'CSV must have header + data rows';
        el('csvStatus').style.color = '#dc2626';
        return;
      }

      const headerLine = lines[0];
      const header = headerLine.includes(',')
        ? headerLine.split(',').map(h => h.trim().replace(/^["']|["']$/g,''))
        : parseCSVLine(headerLine).map(h => h.trim().replace(/^["']|["']$/g,''));

      const skuIdx       = header.findIndex(h => ['SELLER SKU','Seller SKU','SELLER_SKU','Seller_SKU'].includes(h));
      const dateIdx      = header.findIndex(h => ['Rate Date','RateDate','RATE DATE','Date'].includes(h));

      const nfbfCommIdx  = header.findIndex(h => ['NFBF_Comm','NFBF Comm','NFBF_COMM'].includes(h));
      const fbfCommIdx   = header.findIndex(h => ['FBF_Comm','FBF Comm','FBF_COMM'].includes(h));

      const nfbfBronzeIdx  = header.findIndex(h => ['NFBF_Bronze','NFBF Bronze','NFBF_BRONZE'].includes(h));
      const nfbfSilverIdx  = header.findIndex(h => ['NFBF_Silver','NFBF Silver','NFBF_SILVER'].includes(h));
      const nfbfGoldIdx    = header.findIndex(h => ['NFBF_Gold','NFBF Gold','NFBF_GOLD'].includes(h));
      const nfbfDimondIdx  = header.findIndex(h => ['NFBF_Dimond','NFBF Diamond','NFBF_DIAMOND'].includes(h));

      const fbfBronzeIdx   = header.findIndex(h => ['FBF_Bronze','FBF Bronze','FBF_BRONZE'].includes(h));
      const fbfSilverIdx   = header.findIndex(h => ['FBF_Silver','FBF Silver','FBF_SILVER'].includes(h));
      const fbfGoldIdx     = header.findIndex(h => ['FBF_Gold','FBF Gold','FBF_GOLD'].includes(h));
      const fbfDimondIdx   = header.findIndex(h => ['FBF_Dimond','FBF Diamond','FBF_DIAMOND'].includes(h));

      if (skuIdx === -1) {
        el('csvStatus').innerHTML =
          `<b>Error:</b> SELLER SKU column not found<br>Columns: ${header.join(', ')}`;
        el('csvStatus').style.color = '#dc2626';
        return;
      }

      const defaultDate = currentDate;

      const readPercent = (parts, idx) => {
        if (idx === -1 || !parts[idx]) return null;
        const raw = parts[idx].toString().trim().replace(/^["']|["']$/g,'');
        if (!raw) return null;
        const cleaned = raw.replace(/[%\s]/g,'');
        const num = parseFloat(cleaned);
        return isNaN(num) ? null : num/100;
      };

      const readNumber = (parts, idx) => {
        if (idx === -1 || !parts[idx]) return null;
        const raw = parts[idx].toString().trim().replace(/^["']|["']$/g,'');
        if (!raw) return null;
        const num = parseFloat(raw);
        return isNaN(num) ? null : num;
      };

      commissionData = {};
      let rowCount = 0;
      const uniqueDates = new Set();

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line || !line.trim()) continue;

        const parts = line.includes('"') ? parseCSVLine(line)
                                         : line.split(',').map(p => p.trim());
        if (parts.length < header.length) continue;

        const sku = (parts[skuIdx] || '').trim().replace(/^["']|["']$/g,'');
        if (!sku) continue;

        let rateDate = defaultDate;
        if (dateIdx !== -1 && parts[dateIdx]) {
          const rawDate = parts[dateIdx].trim().replace(/^["']|["']$/g,'');
          if (rawDate) {
            const converted = convertToStandardDate(rawDate);
            rateDate = converted || defaultDate;
          }
        }
        uniqueDates.add(rateDate);

        const nfbfComm = readPercent(parts, nfbfCommIdx);
        const fbfComm  = readPercent(parts, fbfCommIdx);

        const nfbfFixed = {
          bronze: readNumber(parts, nfbfBronzeIdx),
          silver: readNumber(parts, nfbfSilverIdx),
          gold:   readNumber(parts, nfbfGoldIdx),
          diamond:readNumber(parts, nfbfDimondIdx)
        };
        const fbfFixed = {
          bronze: readNumber(parts, fbfBronzeIdx),
          silver: readNumber(parts, fbfSilverIdx),
          gold:   readNumber(parts, fbfGoldIdx),
          diamond:readNumber(parts, fbfDimondIdx)
        };

        if (!commissionData[sku]) commissionData[sku] = {};
        if (!commissionData[sku][rateDate]) commissionData[sku][rateDate] = {};

        commissionData[sku][rateDate].nfbf = {
          commission: nfbfComm,
          fixed: nfbfFixed
        };
        commissionData[sku][rateDate].fbf = {
          commission: fbfComm,
          fixed: fbfFixed
        };

        rowCount++;
      }

      populateSKUs();
      allDates = Array.from(uniqueDates).sort();

      if (rowCount === 0) {
        el('csvStatus').textContent = 'No valid rows found in CSV';
        el('csvStatus').style.color = '#dc2626';
        return;
      }

      const minDate = allDates[0] || defaultDate;
      const maxDate = allDates[allDates.length-1] || defaultDate;
      const dateRange = allDates.length === 1
        ? formatDateForDisplay(minDate)
        : `${formatDateForDisplay(minDate)} to ${formatDateForDisplay(maxDate)}`;

      el('csvStatus').innerHTML =
        `<b style="color:#16a34a;">‚úì SUCCESS!</b><br><b>${file.name}</b><br>` +
       // `‚Ä¢ ${rowCount} products loaded<br>` +
        `‚Ä¢ ${allSKUs.length} unique SKUs<br>`;
       // `‚Ä¢ ${allDates.length} date(s): ${dateRange}`;
      el('csvStatus').style.color = '#16a34a';

      compute();
    };

    reader.onerror = function(err){
      console.error('File read error:', err);
      el('csvStatus').textContent = 'Error reading file';
      el('csvStatus').style.color = '#dc2626';
    };

    reader.readAsText(file,'UTF-8');
  }
*/
  async function fetchFromGoogleSheets(){
    el('csvStatus').innerHTML = '<b>‚è≥ Fetching data...</b>';
    el('csvStatus').style.color = '#2563eb';
    
    try {
      const response = await fetch(SHEETS_API_URL);
      if (!response.ok) throw new Error('Failed to fetch');
      
      const jsonData = await response.json();
      
      if (!jsonData || jsonData.length === 0) {
        throw new Error('No data received');
      }
      
      const defaultDate = currentDate;
      commissionData = {};
      const uniqueDates = new Set();
      let rowCount = 0;
      
      jsonData.forEach(row => {
        const sku = (row['SELLER SKU'] || '').toString().trim();
        if (!sku) return;
        
        let rateDate = defaultDate;
        if (row['Rate Date']) {
          const rawDate = row['Rate Date'].toString().trim();
          const converted = convertToStandardDate(rawDate);
          rateDate = converted || defaultDate;
        }
        uniqueDates.add(rateDate);
        
        const readPercent = (val) => {
          if (!val) return null;
          const str = val.toString().replace(/[%\s]/g, '');
          const num = parseFloat(str);
          return isNaN(num) ? null : num / 100;
        };
        
        const readNumber = (val) => {
          if (val == null || val === '') return null;
          const num = parseFloat(val);
          return isNaN(num) ? null : num;
        };
        
        const nfbfComm = readPercent(row['NFBF_Comm']);
        const fbfComm = readPercent(row['FBF_Comm']);
        
        const nfbfFixed = {
          bronze: readNumber(row['NFBF_Bronze']),
          silver: readNumber(row['NFBF_Silver']),
          gold: readNumber(row['NFBF_Gold']),
          diamond: readNumber(row['NFBF_Dimond'])
        };
        
        const fbfFixed = {
          bronze: readNumber(row['FBF_Bronze']),
          silver: readNumber(row['FBF_Silver']),
          gold: readNumber(row['FBF_Gold']),
          diamond: readNumber(row['FBF_Dimond'])
        };
        
        if (!commissionData[sku]) commissionData[sku] = {};
        if (!commissionData[sku][rateDate]) commissionData[sku][rateDate] = {};
        
        commissionData[sku][rateDate].nfbf = {
          commission: nfbfComm,
          fixed: nfbfFixed
        };
        commissionData[sku][rateDate].fbf = {
          commission: fbfComm,
          fixed: fbfFixed
        };
        
        rowCount++;
      });
      
      populateSKUs();
      allDates = Array.from(uniqueDates).sort();
      
      if (allDates.length > 0) {
        latestSheetDate = allDates[allDates.length - 1];
        el('dateInput').value = latestSheetDate;
      }
      
      const dateDisplay = latestSheetDate ? formatDateForDisplay(latestSheetDate) : 'N/A';
      el('csvStatus').innerHTML = 
        `<b style="color:#16a34a;">‚úì Live Data</b><br>` +
        `üìä ${allSKUs.length} SKUs | üìÖ Latest: ${dateDisplay}`;
      el('csvStatus').style.color = '#16a34a';
      
      return true;
      
    } catch (error) {
      console.error('Fetch error:', error);
      el('csvStatus').innerHTML = 
        `<b style="color:#dc2626;">‚úó Error</b><br>` +
        `Failed to fetch from Google Sheets<br>` +
        `<small>${error.message}</small>`;
      el('csvStatus').style.color = '#dc2626';
      return false;
    }
  }
  function init(){
    el('dateInput').value = currentDate;

    const savedTier = sessionStorage.getItem('selectedTier');
    if (savedTier && ['bronze','silver','gold','diamond'].includes(savedTier)) {
      currentTier = savedTier;
      document.querySelectorAll('.tier-btn').forEach(btn => {
        btn.classList.remove('active');
        if(btn.dataset.tier === savedTier){ btn.classList.add('active'); }
      });
    }

    document.querySelectorAll('.tier-btn').forEach(btn => {
      btn.addEventListener('click', () => setTier(btn.dataset.tier));
    });

    el('dateInput').addEventListener('change', e => setDate(e.target.value));
    initSearchableDropdown();

    el('calcBtn').addEventListener('click', compute);
    el('resetBtn').addEventListener('click', resetUI);
    el('priceInput').addEventListener('keydown', e => { if (e.key === 'Enter') compute(); });
    el('modeBox').addEventListener('change', updateModeUI);
    el('fAssured').addEventListener('change', compute);

    //el('loadCsvBtn').addEventListener('click', () => el('csvInput').click());
    //el('csvInput').addEventListener('change', e => {
    //  if (e.target.files && e.target.files[0]) handleCsvFile(e.target.files[0]);
    //});
  }

  document.querySelectorAll('img').forEach(img => {
    img.addEventListener('error', function() {
      el('imgErr').style.display = 'inline';
    });
  });

  updateModeUI();
  init();
  resetUI();
  
  // Auto-fetch on page load
  fetchFromGoogleSheets();
</script>
</body>
</html>
